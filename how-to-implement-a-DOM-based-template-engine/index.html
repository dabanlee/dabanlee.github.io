<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        
            å¦‚ä½•å®ç°ä¸€ä¸ªåŸºäº DOM çš„æ¨¡æ¿å¼•æ“ - å¤§æ¿æ —æƒ³å†™ç‚¹ä¸œè¥¿
        
    </title>
    <meta name="keywords" content>
    <meta name="description" content>
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="/dist/css/github-gist.css">
    <link rel="stylesheet" href="/dist/css/app.css">
</head>


<body data-page="article">

</body></html>
<header class="Header">
    <nav class="Nav">
        <div class="container">
            <div class="Logo">
                <a href="https://justclear.github.io">
                    <img src="/images/logo.jpg" alt="å¤§æ¿æ —æƒ³å†™ç‚¹ä¸œè¥¿">
                </a>
            </div>
            <ul class="menu">
                
                <li><a href="/">HOME</a></li>
                
                <li><a href="/idea">IDEA</a></li>
                
                <li><a href="https://unsplash.com/@dabanli">PHOTOGRAPHY</a></li>
                
                <li><a href="/about/">ABOUT</a></li>
                
                <li><a href="https://github.com/justclear">GITHUB</a></li>
                
            </ul>
            <div class="icon-menu js-icon-menu"></div>
        </div>
    </nav>
</header>
<ul class="menu-mobile js-menu-mobile">
    
    <li><a href="/">HOME</a></li>
    
    <li><a href="/idea">IDEA</a></li>
    
    <li><a href="https://unsplash.com/@dabanli">PHOTOGRAPHY</a></li>
    
    <li><a href="/about/">ABOUT</a></li>
    
    <li><a href="https://github.com/justclear">GITHUB</a></li>
    
</ul>


<div class="page-content">
    <div class="container">
        <article class="article">
            <header class="article-header">
                <h1 class="article-title">å¦‚ä½•å®ç°ä¸€ä¸ªåŸºäº DOM çš„æ¨¡æ¿å¼•æ“</h1>
                
            </header>
            <section class="article-content">
                 <blockquote>
<p>é¢˜å›¾ï¼š<a href="https://unsplash.com/photos/ISI5DlnYvuY" target="_blank" rel="noopener">Vincent Guth</a></p>
</blockquote>
<blockquote>
<p>é¦–å‘äº <a href="https://zhuanlan.zhihu.com/p/28376182" target="_blank" rel="noopener">ã€ŒçŸ¥ä¹ä¸“æ  Â· é»‘å®¢ä¸ç”»å®¶ã€</a></p>
</blockquote>
<p>å¯èƒ½ä½ å·²ç»ä½“ä¼šåˆ°äº† <code>Vue</code> æ‰€å¸¦æ¥çš„ä¾¿æ·äº†ï¼Œç›¸ä¿¡æœ‰ä¸€éƒ¨åˆ†åŸå› ä¹Ÿæ˜¯å› ä¸ºå…¶åŸºäº DOM çš„è¯­æ³•ç®€æ´çš„æ¨¡æ¿æ¸²æŸ“å¼•æ“ã€‚è¿™ç¯‡æ–‡ç« å°†ä¼šä»‹ç»å¦‚ä½•å®ç°ä¸€ä¸ªåŸºäº DOM çš„æ¨¡æ¿å¼•æ“ï¼ˆå°±åƒ <code>Vue</code> çš„æ¨¡æ¿å¼•æ“ä¸€æ ·ï¼‰ã€‚</p>
<h2 id="Preface"><a href="#Preface" class="headerlink" title="Preface"></a>Preface</h2><p>å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹æœ€ç»ˆçš„æ•ˆæœï¼š</p>
<pre><code class="js">const compiled = Compile(`&lt;h1&gt;Hey ğŸŒ°, {{ greeting }}&lt;/h1&gt;`, {
    greeting: `Hello World`,
});
compiled.view // =&gt; `&lt;h1&gt;Hey ğŸŒ°, Hello World&lt;/h1&gt;`</code></pre>
<h2 id="Compile"><a href="#Compile" class="headerlink" title="Compile"></a>Compile</h2><p>å®ç°ä¸€ä¸ªæ¨¡æ¿å¼•æ“å®é™…ä¸Šå°±æ˜¯å®ç°ä¸€ä¸ªç¼–è¯‘å™¨ï¼Œå°±åƒè¿™æ ·ï¼š</p>
<pre><code class="js">const compiled = Compile(template: String | Node, data: Object);
compiled.view // =&gt; compiled template</code></pre>
<p>é¦–å…ˆï¼Œè®©æˆ‘ä»¬æ¥çœ‹ä¸‹ <code>Compile</code> å†…éƒ¨æ˜¯å¦‚ä½•å®ç°çš„ï¼š</p>
<pre><code class="js">// compile.js
/**
 * template compiler
 *
 * @param {String|Node} template
 * @param {Object} data
 */
function Compile(template, data) {
    if (!(this instanceof Compile)) return new Compile(template, data);

    this.options = {};
    this.data = data;

    if (template instanceof Node) {
        this.options.template = template;
    } else if (typeof template === &#39;string&#39;) {
        this.options.template = domify(template);
    } else {
        console.error(`&quot;template&quot; only accept DOM node or string template`);
    }

    template = this.options.template;

    walk(template, (node, next) =&gt; {
        if (node.nodeType === 1) {
            // compile element node
            this.compile.elementNodes.call(this, node);
            return next();
        } else if (node.nodeType === 3) {
            // compile text node
            this.compile.textNodes.call(this, node);
        }
        next();
    });

    this.view = template;
    template = null;
}

Compile.compile = {};</code></pre>
<h3 id="walk"><a href="#walk" class="headerlink" title="walk"></a>walk</h3><p>é€šè¿‡ä¸Šé¢çš„ä»£ç ï¼Œå¯ä»¥çœ‹åˆ° <code>Compile</code> çš„æ„é€ å‡½æ•°ä¸»è¦å°±æ˜¯åšäº†ä¸€ä»¶äº‹ â€”â€”â€”â€” éå† <code>template</code>ï¼Œç„¶åé€šè¿‡åˆ¤æ–­èŠ‚ç‚¹ç±»å‹çš„ä¸åŒæ¥åšä¸åŒçš„ç¼–è¯‘æ“ä½œï¼Œè¿™é‡Œå°±ä¸ä»‹ç»å¦‚ä½•éå† <code>template</code> äº†ï¼Œä¸æ˜ç™½çš„è¯å¯ä»¥ç›´æ¥çœ‹ <code>walk</code> <a href="https://github.com/colonjs/colon/blob/master/src/compile/walk.js" target="_blank" rel="noopener">å‡½æ•°çš„æºç </a>ï¼Œæˆ‘ä»¬ç€é‡æ¥çœ‹ä¸‹å¦‚ä½•ç¼–è¯‘è¿™äº›ä¸åŒç±»å‹çš„èŠ‚ç‚¹ï¼Œä»¥ç¼–è¯‘ <code>node.nodeType === 1</code> çš„å…ƒç´ èŠ‚ç‚¹ä¸ºä¾‹ï¼š</p>
<pre><code class="js">/**
 * compile element node
 *
 * @param {Node} node
 */
Compile.compile.elementNodes = function (node) {
    const bindSymbol = `:`;
    const attributes = [].slice.call(node.attributes);

    attributes.map(attribute =&gt; {
        const attributeName = attribute.name;
        const attributeValue = attribute.value.trim();

        if (attributeName.indexOf(bindSymbol) === 0 &amp;&amp; attributeValue !== &#39;&#39;) {
            const directiveName = attributeName.slice(bindSymbol.length);

            this.bindDirective({
                node,
                expression: attributeValue,
                name: directiveName,
            });
            node.removeAttribute(attributeName);
        } else {
            this.bindAttribute(node, attribute);
        }
    });
};</code></pre>
<p>å™¢å¿˜è®°è¯´äº†ï¼Œè¿™é‡Œæˆ‘å‚è€ƒäº† <code>Vue</code> çš„æŒ‡ä»¤è¯­æ³•ï¼Œå°±æ˜¯åœ¨å¸¦æœ‰å†’å· <code>:</code> çš„å±æ€§åä¸­ï¼ˆå½“ç„¶è¿™é‡Œä¹Ÿå¯ä»¥æ˜¯ä»»ä½•å…¶ä»–ä½ æ‰€å–œæ¬¢çš„ç¬¦å·ï¼‰ï¼Œå¯ä»¥ç›´æ¥å†™ JavaScript çš„è¡¨è¾¾å¼ï¼Œç„¶åä¹Ÿä¼šæä¾›å‡ ä¸ªç‰¹æ®Šçš„æŒ‡ä»¤ï¼Œä¾‹å¦‚ <code>:text</code>, <code>:show</code> ç­‰ç­‰æ¥å¯¹å…ƒç´ åšä¸€äº›ä¸åŒçš„æ“ä½œã€‚</p>
<p>å…¶å®è¯¥å‡½æ•°åªåšäº†ä¸¤ä»¶äº‹ï¼š</p>
<ul>
<li>éå†è¯¥èŠ‚ç‚¹çš„æ‰€æœ‰å±æ€§ï¼Œé€šè¿‡åˆ¤æ–­å±æ€§ç±»å‹çš„ä¸åŒæ¥åšä¸åŒçš„æ“ä½œï¼Œåˆ¤æ–­çš„æ ‡å‡†å°±æ˜¯å±æ€§åæ˜¯å¦æ˜¯å†’å· <code>:</code> å¼€å¤´å¹¶ä¸”å±æ€§çš„å€¼ä¸ä¸ºç©ºï¼›</li>
<li>ç»‘å®šç›¸åº”çš„æŒ‡ä»¤å»æ›´æ–°å±æ€§ã€‚</li>
</ul>
<h2 id="Directive"><a href="#Directive" class="headerlink" title="Directive"></a>Directive</h2><p>å…¶æ¬¡ï¼Œå†çœ‹ä¸€ä¸‹ <code>Directive</code> å†…éƒ¨æ˜¯å¦‚ä½•å®ç°çš„ï¼š</p>
<pre><code class="js">import directives from &#39;./directives&#39;;
import { generate } from &#39;./compile/generate&#39;;

export default function Directive(options = {}) {
    Object.assign(this, options);
    Object.assign(this, directives[this.name]);
    this.beforeUpdate &amp;&amp; this.beforeUpdate();
    this.update &amp;&amp; this.update(generate(this.expression)(this.compile.data));
}</code></pre>
<p><code>Directive</code> åšäº†ä¸‰ä»¶äº‹ï¼š</p>
<ul>
<li>æ³¨å†ŒæŒ‡ä»¤ï¼ˆ<code>Object.assign(this, directives[this.name])</code>ï¼‰ï¼›</li>
<li>è®¡ç®—æŒ‡ä»¤è¡¨è¾¾å¼çš„å®é™…å€¼ï¼ˆ<code>generate(this.expression)(this.compile.data)</code>ï¼‰ï¼›</li>
<li>æŠŠè®¡ç®—å‡ºæ¥çš„å®é™…å€¼æ›´æ–°åˆ° DOM ä¸Šé¢(<code>this.update()</code>)ã€‚</li>
</ul>
<p>åœ¨ä»‹ç»æŒ‡ä»¤ä¹‹å‰ï¼Œå…ˆçœ‹ä¸€ä¸‹å®ƒçš„ç”¨æ³•ï¼š</p>
<pre><code class="js">Compile.prototype.bindDirective = function (options) {
    new Directive({
        ...options,
        compile: this,
    });
};

Compile.prototype.bindAttribute = function (node, attribute) {
    if (!hasInterpolation(attribute.value) || attribute.value.trim() == &#39;&#39;) return false;

    this.bindDirective({
        node,
        name: &#39;attribute&#39;,
        expression: parse.text(attribute.value),
        attrName: attribute.name,
    });
};</code></pre>
<p><code>bindDirective</code> å¯¹ <code>Directive</code> åšäº†ä¸€ä¸ªéå¸¸ç®€å•çš„å°è£…ï¼Œæ¥å—ä¸‰ä¸ªå¿…å¡«å±æ€§ï¼š</p>
<ul>
<li><code>node</code>: å½“å‰æ‰€ç¼–è¯‘çš„èŠ‚ç‚¹ï¼Œåœ¨ <code>Directive</code> çš„ <code>update</code> æ–¹æ³•ä¸­ç”¨æ¥æ›´æ–°å½“å‰èŠ‚ç‚¹ï¼›</li>
<li><code>name</code>: å½“å‰æ‰€ç»‘å®šçš„æŒ‡ä»¤åç§°ï¼Œç”¨æ¥åŒºåˆ†å…·ä½“ä½¿ç”¨å“ªä¸ªæŒ‡ä»¤æ›´æ–°å™¨æ¥æ›´æ–°è§†å›¾ï¼›</li>
<li><code>expression</code>: parse ä¹‹åçš„ JavaScript çš„è¡¨è¾¾å¼ã€‚</li>
</ul>
<h3 id="updater"><a href="#updater" class="headerlink" title="updater"></a>updater</h3><p>åœ¨ <code>Directive</code> å†…éƒ¨æˆ‘ä»¬é€šè¿‡ <code>Object.assign(this, directives[this.name]);</code> æ¥æ³¨å†Œä¸åŒçš„æŒ‡ä»¤ï¼Œæ‰€ä»¥å˜é‡ <code>directives</code> çš„å€¼å¯èƒ½æ˜¯è¿™æ ·çš„ï¼š</p>
<pre><code class="js">// directives
export default {
    // directive `:show`
    show: {
        beforeUpdate() {},
        update(show) {
            this.node.style.display = show ? `block` : `none`;
        },
    },
    // directive `:text`
    text: {
        beforeUpdate() {},
        update(value) {
            // ...
        },
    },
};</code></pre>
<p>æ‰€ä»¥å‡è®¾æŸä¸ªæŒ‡ä»¤çš„åå­—æ˜¯ <code>show</code> çš„è¯ï¼Œé‚£ä¹ˆ <code>Object.assign(this, directives[this.name]);</code> å°±ç­‰åŒäºï¼š</p>
<pre><code class="js">Object.assign(this, {
    beforeUpdate() {},
    update(show) {
        this.node.style.display = show ? `block` : `none`;
    },
});</code></pre>
<p>è¡¨ç¤ºå¯¹äºæŒ‡ä»¤ <code>show</code>ï¼ŒæŒ‡ä»¤æ›´æ–°å™¨ä¼šæ”¹å˜è¯¥å…ƒç´  <code>style</code> çš„ <code>display</code> å€¼ï¼Œä»è€Œå®ç°å¯¹åº”çš„åŠŸèƒ½ã€‚æ‰€ä»¥ä½ ä¼šå‘ç°ï¼Œæ•´ä¸ªç¼–è¯‘å™¨ç»“æ„è®¾è®¡å¥½åï¼Œå¦‚æœæˆ‘ä»¬è¦æ‹“å±•åŠŸèƒ½çš„è¯ï¼Œåªéœ€ç®€å•åœ°ç¼–å†™æŒ‡ä»¤çš„æ›´æ–°å™¨å³å¯ï¼Œè¿™é‡Œå†ä»¥æŒ‡ä»¤ <code>text</code> ä¸¾ä¸ªä¾‹å­ï¼š</p>
<pre><code class="js">// directives
export default {
    // directive `:show`
    // show: { ... },
    // directive `:text`
    text: {
        update(value) {
            this.node.textContent = value;
        },
    },
};</code></pre>
<p>æœ‰æ²¡æœ‰å‘ç°ç¼–å†™ä¸€ä¸ªæŒ‡ä»¤å…¶å®éå¸¸çš„ç®€å•ï¼Œç„¶åæˆ‘ä»¬å°±å¯ä»¥è¿™ä¹ˆä½¿ç”¨æˆ‘ä»¬çš„ <code>text</code> æŒ‡ä»¤äº†ï¼š</p>
<pre><code class="js">const compiled = Compile(`&lt;h1 :text=&quot;&#39;Hey ğŸŒ°, &#39; + greeting&quot;&gt;&lt;/h1&gt;`, {
    greeting: `Hello World`,
});
compiled.view // =&gt; `&lt;h1&gt;Hey ğŸŒ°, Hello World&lt;/h1&gt;`</code></pre>
<h3 id="generate"><a href="#generate" class="headerlink" title="generate"></a>generate</h3><p>è®²åˆ°è¿™é‡Œï¼Œå…¶å®è¿˜æœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„ç‚¹æ²¡æœ‰æåˆ°ï¼Œå°±æ˜¯æˆ‘ä»¬å¦‚ä½•æŠŠ <code>data</code> çœŸå®æ•°æ®æ¸²æŸ“åˆ°æ¨¡æ¿ä¸­ï¼Œæ¯”å¦‚ <code>&lt;h1&gt;Hey ğŸŒ°, &lt;/h1&gt;</code> å¦‚ä½•æ¸²æŸ“æˆ <code>&lt;h1&gt;Hey ğŸŒ°, Hello World&lt;/h1&gt;</code>ï¼Œé€šè¿‡ä¸‹é¢ä¸‰ä¸ªæ­¥éª¤å³å¯è®¡ç®—å‡ºè¡¨è¾¾å¼çš„çœŸå®æ•°æ®ï¼š</p>
<ul>
<li>æŠŠ <code>&lt;h1&gt;Hey ğŸŒ°, &lt;/h1&gt;</code> è§£ææˆ <code>&#39;Hey ğŸŒ°, &#39; + greeting</code> è¿™æ ·çš„ JavaScript è¡¨è¾¾å¼ï¼›</li>
<li>æå–å…¶ä¸­çš„ä¾èµ–å˜é‡å¹¶å–å¾—æ‰€åœ¨ <code>data</code> ä¸­çš„å¯¹åº”å€¼ï¼›</li>
<li>åˆ©ç”¨ <code>new Function()</code> æ¥åˆ›å»ºä¸€ä¸ªåŒ¿åå‡½æ•°æ¥è¿”å›è¿™ä¸ªè¡¨è¾¾å¼ï¼›</li>
<li>æœ€åé€šè¿‡è°ƒç”¨è¿™ä¸ªåŒ¿åå‡½æ•°æ¥è¿”å›æœ€ç»ˆè®¡ç®—å‡ºæ¥çš„æ•°æ®å¹¶é€šè¿‡æŒ‡ä»¤çš„ <code>update</code> æ–¹æ³•æ›´æ–°åˆ°è§†å›¾ä¸­ã€‚</li>
</ul>
<h4 id="parse-text"><a href="#parse-text" class="headerlink" title="parse text"></a>parse text</h4><pre><code class="js">// reference: https://github.com/vuejs/vue/blob/dev/src/compiler/parser/text-parser.js#L15-L41
const tagRE = /\{\{((?:.|\n)+?)\}\}/g;
function parse(text) {
    if (!tagRE.test(text)) return JSON.stringify(text);

    const tokens = [];
    let lastIndex = tagRE.lastIndex = 0;
    let index, matched;

    while (matched = tagRE.exec(text)) {
        index = matched.index;
        if (index &gt; lastIndex) {
            tokens.push(JSON.stringify(text.slice(lastIndex, index)));
        }
        tokens.push(matched[1].trim());
        lastIndex = index + matched[0].length;
    }

    if (lastIndex &lt; text.length) tokens.push(JSON.stringify(text.slice(lastIndex)));

    return tokens.join(&#39;+&#39;);
}</code></pre>
<p>è¯¥å‡½æ•°æˆ‘æ˜¯ç›´æ¥å‚è€ƒ <code>Vue</code> çš„å®ç°ï¼Œå®ƒä¼šæŠŠå«æœ‰åŒèŠ±æ‹¬å·çš„å­—ç¬¦ä¸²è§£ææˆæ ‡å‡†çš„ JavaScript è¡¨è¾¾å¼ï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="js">parse(`Hi {{ user.name }}, {{ colon }} is awesome.`);
// =&gt; &#39;Hi &#39; + user.name + &#39;, &#39; + colon + &#39; is awesome.&#39;</code></pre>
<h4 id="extract-dependency"><a href="#extract-dependency" class="headerlink" title="extract dependency"></a>extract dependency</h4><p>æˆ‘ä»¬ä¼šé€šè¿‡ä¸‹é¢è¿™ä¸ªå‡½æ•°æ¥æå–å‡ºä¸€ä¸ªè¡¨è¾¾å¼ä¸­å¯èƒ½å­˜åœ¨çš„å˜é‡ï¼š</p>
<pre><code class="js">const dependencyRE = /&quot;[^&quot;]*&quot;|&#39;[^&#39;]*&#39;|\.\w*[a-zA-Z$_]\w*|\w*[a-zA-Z$_]\w*:|(\w*[a-zA-Z$_]\w*)/g;
const globals = [
    &#39;true&#39;, &#39;false&#39;, &#39;undefined&#39;, &#39;null&#39;, &#39;NaN&#39;, &#39;isNaN&#39;, &#39;typeof&#39;, &#39;in&#39;,
    &#39;decodeURI&#39;, &#39;decodeURIComponent&#39;, &#39;encodeURI&#39;, &#39;encodeURIComponent&#39;, &#39;unescape&#39;,
    &#39;escape&#39;, &#39;eval&#39;, &#39;isFinite&#39;, &#39;Number&#39;, &#39;String&#39;, &#39;parseFloat&#39;, &#39;parseInt&#39;,
];

function extractDependencies(expression) {
    const dependencies = [];

    expression.replace(dependencyRE, (match, dependency) =&gt; {
        const isDefined = dependency =&gt; dependency !== undefined;
        const hasDependency = (dependencies, dependency) =&gt; dependencies.includes(dependency);
        const hasGlobal = (globals, dependency) =&gt; globals.includes(dependency);

        if (isDefined(dependency) &amp;&amp; !hasDependency(dependencies, dependency) &amp;&amp; !hasGlobal(globals, dependency)) {
            dependencies.push(dependency);
        }
    });

    return dependencies;
}</code></pre>
<p>é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼ <code>dependencyRE</code> åŒ¹é…å‡ºå¯èƒ½çš„å˜é‡ä¾èµ–åï¼Œè¿˜è¦è¿›è¡Œä¸€äº›å¯¹æ¯”ï¼Œæ¯”å¦‚æ˜¯å¦æ˜¯å…¨å±€å˜é‡ç­‰ç­‰ã€‚æ•ˆæœå¦‚ä¸‹ï¼š</p>
<pre><code class="js">extractDependencies(`typeof String(name) === &#39;string&#39;  &amp;&amp; &#39;Hello &#39; + world + &#39;! &#39; + hello.split(&#39;&#39;).join(&#39;&#39;) + &#39;.&#39;`);
// =&gt; [&quot;name&quot;, &quot;world&quot;, &quot;hello&quot;]</code></pre>
<p>è¿™æ­£æ˜¯æˆ‘ä»¬éœ€è¦çš„ç»“æœï¼Œ<code>typeof</code>, <code>String</code>, <code>split</code> å’Œ <code>join</code> å¹¶ä¸æ˜¯ <code>data</code> ä¸­æ‰€ä¾èµ–çš„å˜é‡ï¼Œæ‰€ä»¥ä¸éœ€è¦è¢«æå–å‡ºæ¥ã€‚</p>
<h4 id="generate-1"><a href="#generate-1" class="headerlink" title="generate"></a>generate</h4><pre><code class="js">export function generate(expression) {
    const dependencies = extractDependencies(expression);
    const dependenciesCode = dependencies.reduce((prev, current) =&gt; {
        prev += `var ${current} = data[&quot;${current}&quot;]; `
        return prev;
    }, &#39;&#39;);

    return new Function(`data`, `${dependenciesCode}return ${expression};`);
}</code></pre>
<p>æˆ‘ä»¬æå–å˜é‡çš„ç›®çš„å°±æ˜¯ä¸ºäº†åœ¨ <code>generate</code> å‡½æ•°ä¸­ç”Ÿæˆç›¸åº”çš„å˜é‡èµ‹å€¼çš„å­—ç¬¦ä¸²ä¾¿äºåœ¨ <code>generate</code> å‡½æ•°ä¸­ä½¿ç”¨ï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="js">new Function(`data`, `
    var name = data[&quot;name&quot;];
    var world = data[&quot;world&quot;];
    var hello = data[&quot;hello&quot;];
    return typeof String(name) === &#39;string&#39;  &amp;&amp; &#39;Hello &#39; + world + &#39;! &#39; + hello.split(&#39;&#39;).join(&#39;&#39;) + &#39;.&#39;;
`);

// will generated:

function anonymous(data) {
    var name = data[&quot;name&quot;];
    var world = data[&quot;world&quot;];
    var hello = data[&quot;hello&quot;];
    return typeof String(name) === &#39;string&#39;  &amp;&amp; &#39;Hello &#39; + world + &#39;! &#39; + hello.split(&#39;&#39;).join(&#39;&#39;) + &#39;.&#39;;
}</code></pre>
<p>è¿™æ ·çš„è¯ï¼Œåªéœ€è¦åœ¨è°ƒç”¨è¿™ä¸ªåŒ¿åå‡½æ•°çš„æ—¶å€™ä¼ å…¥å¯¹åº”çš„ <code>data</code> å³å¯è·å¾—æˆ‘ä»¬æƒ³è¦çš„ç»“æœäº†ã€‚ç°åœ¨å›è¿‡å¤´æ¥çœ‹ä¹‹å‰çš„ <code>Directive</code> éƒ¨åˆ†ä»£ç åº”è¯¥å°±ä¸€ç›®äº†ç„¶äº†ï¼š</p>
<pre><code class="js">export default class Directive {
    constructor(options = {}) {
        // ...
        this.beforeUpdate &amp;&amp; this.beforeUpdate();
        this.update &amp;&amp; this.update(generate(this.expression)(this.compile.data));
    }
}</code></pre>
<p><code>generate(this.expression)(this.compile.data)</code> å°±æ˜¯è¡¨è¾¾å¼ç»è¿‡ <code>this.compile.data</code> è®¡ç®—åæˆ‘ä»¬æ‰€éœ€è¦çš„å€¼ã€‚</p>
<h3 id="compile-text-node"><a href="#compile-text-node" class="headerlink" title="compile text node"></a>compile text node</h3><p>æˆ‘ä»¬å‰é¢åªè®²äº†å¦‚ä½•ç¼–è¯‘ <code>node.nodeType === 1</code> çš„å…ƒç´ èŠ‚ç‚¹ï¼Œé‚£ä¹ˆæ–‡å­—èŠ‚ç‚¹å¦‚ä½•ç¼–è¯‘å‘¢ï¼Œå…¶å®ç†è§£äº†å‰é¢æ‰€è®²çš„å†…å®¹è¯ï¼Œæ–‡å­—èŠ‚ç‚¹çš„ç¼–è¯‘å°±ç®€å•å¾—ä¸èƒ½å†ç®€å•äº†ï¼š</p>
<pre><code class="js">/**
 * compile text node
 *
 * @param {Node} node
 */
Compile.compile.textNodes = function (node) {
    if (node.textContent.trim() === &#39;&#39;) return false;

    this.bindDirective({
        node,
        name: &#39;text&#39;,
        expression: parse.text(node.textContent),
    });
};</code></pre>
<p>é€šè¿‡ç»‘å®š <code>text</code> æŒ‡ä»¤ï¼Œå¹¶ä¼ å…¥è§£æåçš„ JavaScript è¡¨è¾¾å¼ï¼Œåœ¨ <code>Directive</code> å†…éƒ¨å°±ä¼šè®¡ç®—å‡ºè¡¨è¾¾å¼å®é™…çš„å€¼å¹¶è°ƒç”¨ <code>text</code> çš„ <code>update</code> å‡½æ•°æ›´æ–°è§†å›¾å®Œæˆæ¸²æŸ“ã€‚</p>
<h2 id="each-æŒ‡ä»¤"><a href="#each-æŒ‡ä»¤" class="headerlink" title=":each æŒ‡ä»¤"></a><code>:each</code> æŒ‡ä»¤</h2><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œè¯¥æ¨¡æ¿å¼•æ“åªå®ç°äº†æ¯”è¾ƒåŸºæœ¬çš„åŠŸèƒ½ï¼Œè€Œæœ€å¸¸è§ä¸”é‡è¦çš„åˆ—è¡¨æ¸²æŸ“åŠŸèƒ½è¿˜æ²¡æœ‰å®ç°ï¼Œæ‰€ä»¥æˆ‘ä»¬ç°åœ¨è¦å®ç°ä¸€ä¸ª <code>:each</code> æŒ‡ä»¤æ¥æ¸²æŸ“ä¸€ä¸ªåˆ—è¡¨ï¼Œè¿™é‡Œå¯èƒ½è¦æ³¨æ„ä¸€ä¸‹ï¼Œä¸èƒ½æŒ‰ç…§å‰é¢ä¸¤ä¸ªæŒ‡ä»¤çš„æ€è·¯æ¥å®ç°ï¼Œåº”è¯¥æ¢ä¸€ä¸ªè§’åº¦æ¥æ€è€ƒï¼Œåˆ—è¡¨æ¸²æŸ“å…¶å®ç›¸å½“äºä¸€ä¸ªã€Œå­æ¨¡æ¿ã€ï¼Œé‡Œé¢çš„å˜é‡å­˜åœ¨äº <code>:each</code> æŒ‡ä»¤æ‰€æ¥æ”¶çš„ <code>data</code> è¿™ä¸ªã€Œå±€éƒ¨ä½œç”¨åŸŸã€ä¸­ï¼Œè¿™ä¹ˆè¯´å¯èƒ½æŠ½è±¡ï¼Œç›´æ¥ä¸Šä»£ç ï¼š</p>
<pre><code class="js">// :each updater
import Compile from &#39;path/to/compile.js&#39;;
export default {
    beforeUpdate() {
        this.placeholder = document.createComment(`:each`);
        this.node.parentNode.replaceChild(this.placeholder, this.node);
    },
    update() {
        if (data &amp;&amp; !Array.isArray(data)) return;

        const fragment = document.createDocumentFragment();

        data.map((item, index) =&gt; {
            const compiled = Compile(this.node.cloneNode(true), { item, index, });
            fragment.appendChild(compiled.view);
        });

        this.placeholder.parentNode.replaceChild(fragment, this.placeholder);
    },
};</code></pre>
<p>åœ¨ <code>update</code> ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæŠŠ <code>:each</code> æ‰€åœ¨èŠ‚ç‚¹ä» DOM ç»“æ„ä¸­å»æ‰ï¼Œä½†æ˜¯è¦æ³¨æ„çš„æ˜¯å¹¶ä¸èƒ½ç›´æ¥å»æ‰ï¼Œè€Œæ˜¯è¦åœ¨å»æ‰çš„ä½ç½®æ’å…¥ä¸€ä¸ª <code>comment</code> ç±»å‹çš„èŠ‚ç‚¹ä½œä¸ºå ä½ç¬¦ï¼Œç›®çš„æ˜¯ä¸ºäº†åœ¨æˆ‘ä»¬æŠŠåˆ—è¡¨æ•°æ®æ¸²æŸ“å‡ºæ¥åï¼Œèƒ½æ‰¾å›åŸæ¥çš„ä½ç½®å¹¶æŠŠå®ƒæ’å…¥åˆ° DOM ä¸­ã€‚</p>
<p>é‚£å…·ä½“å¦‚ä½•ç¼–è¯‘è¿™ä¸ªæ‰€è°“çš„ã€Œå­æ¨¡æ¿ã€å‘¢ï¼Œé¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦éå† <code>:each</code> æŒ‡ä»¤æ‰€æ¥æ”¶çš„ <code>Array</code> ç±»å‹çš„æ•°æ®ï¼ˆç›®å‰åªæ”¯æŒè¯¥ç±»å‹ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥å¢åŠ å¯¹ <code>Object</code> ç±»å‹çš„æ”¯æŒï¼ŒåŸç†æ˜¯ä¸€æ ·çš„ï¼‰ï¼›å…¶æ¬¡ï¼Œæˆ‘ä»¬é’ˆå¯¹è¯¥åˆ—è¡¨çš„æ¯ä¸€é¡¹æ•°æ®è¿›è¡Œä¸€æ¬¡æ¨¡æ¿çš„ç¼–è¯‘å¹¶æŠŠæ¸²æŸ“åçš„æ¨¡æ¿æ’å…¥åˆ°åˆ›å»ºçš„ <code>document fragment</code> ä¸­ï¼Œå½“æ‰€æœ‰æ•´ä¸ªåˆ—è¡¨ç¼–è¯‘å®Œåå†æŠŠåˆšåˆšåˆ›å»ºçš„ <code>comment</code> ç±»å‹çš„å ä½ç¬¦æ›¿æ¢ä¸º <code>document fragment</code> ä»¥å®Œæˆåˆ—è¡¨çš„æ¸²æŸ“ã€‚</p>
<p>æ­¤æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥è¿™ä¹ˆä½¿ç”¨ <code>:each</code> æŒ‡ä»¤ï¼š</p>
<pre><code class="js">Compile(`&lt;li :each=&quot;comments&quot; data-index=&quot;{{ index }}&quot;&gt;{{ item.content }}&lt;/li&gt;`, {
    comments: [{
        content: `Hello World.`,
    }, {
        content: `Just Awesome.`,
    }, {
        content: `WOW, Just WOW!`,
    }],
});</code></pre>
<p>ä¼šæ¸²æŸ“æˆï¼š</p>
<pre><code class="html">&lt;li data-index=&quot;0&quot;&gt;Hello World.&lt;/li&gt;
&lt;li data-index=&quot;1&quot;&gt;Just Awesome.&lt;/li&gt;
&lt;li data-index=&quot;2&quot;&gt;WOW, Just WOW!&lt;/li&gt;</code></pre>
<p>å…¶å®ç»†å¿ƒçš„è¯ä½ ä¼šå‘ç°ï¼Œæ¨¡æ¿ä¸­ä½¿ç”¨çš„ <code>item</code> å’Œ <code>index</code> å˜é‡å…¶å®å°±æ˜¯ <code>:each</code> æ›´æ–°å‡½æ•°ä¸­ <code>Compile(template, data)</code> ç¼–è¯‘å™¨é‡Œçš„ <code>data</code> å€¼çš„ä¸¤ä¸ª <code>key</code> å€¼ã€‚æ‰€ä»¥è¦è‡ªå®šä¹‰è¿™ä¸¤ä¸ªå˜é‡ä¹Ÿæ˜¯éå¸¸ç®€å•çš„ï¼š</p>
<pre><code class="js">// :each updater
import Compile from &#39;path/to/compile.js&#39;;
export default {
    beforeUpdate() {
        this.placeholder = document.createComment(`:each`);
        this.node.parentNode.replaceChild(this.placeholder, this.node);

        // parse alias
        this.itemName = `item`;
        this.indexName = `index`;
        this.dataName = this.expression;

        if (this.expression.indexOf(&#39; in &#39;) != -1) {
            const bracketRE = /\(((?:.|\n)+?)\)/g;
            const [item, data] = this.expression.split(&#39; in &#39;);
            let matched = null;

            if (matched = bracketRE.exec(item)) {
                const [item, index] = matched[1].split(&#39;,&#39;);
                index ? this.indexName = index.trim() : &#39;&#39;;
                this.itemName = item.trim();
            } else {
                this.itemName = item.trim();
            }

            this.dataName = data.trim();
        }

        this.expression = this.dataName;
    },
    update() {
        if (data &amp;&amp; !Array.isArray(data)) return;

        const fragment = document.createDocumentFragment();

        data.map((item, index) =&gt; {
            const compiled = Compile(this.node.cloneNode(true), {
                [this.itemName]: item,
                [this.indexName]: index,
            });
            fragment.appendChild(compiled.view);
        });

        this.placeholder.parentNode.replaceChild(fragment, this.placeholder);
    },
};</code></pre>
<p>è¿™æ ·ä¸€æ¥æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ <code>(aliasItem, aliasIndex) in items</code> æ¥è‡ªå®šä¹‰ <code>:each</code> æŒ‡ä»¤çš„ <code>item</code> å’Œ <code>index</code> å˜é‡äº†ï¼ŒåŸç†å°±æ˜¯åœ¨ <code>beforeUpdate</code> çš„æ—¶å€™å»è§£æ <code>:each</code> æŒ‡ä»¤çš„è¡¨è¾¾å¼ï¼Œæå–ç›¸å…³çš„å˜é‡åï¼Œç„¶åä¸Šé¢çš„ä¾‹å­å°±å¯ä»¥å†™æˆè¿™æ ·äº†ï¼š</p>
<pre><code class="js">Compile(`&lt;li :each=&quot;(comment, index) in comments&quot; data-index=&quot;{{ index }}&quot;&gt;{{ comment.content }}&lt;/li&gt;`, {
    comments: [{
        content: `Hello World.`,
    }, {
        content: `Just Awesome.`,
    }, {
        content: `WOW, Just WOW!`,
    }],
});</code></pre>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>åˆ°è¿™é‡Œï¼Œå…¶å®ä¸€ä¸ªæ¯”è¾ƒç®€å•çš„æ¨¡æ¿å¼•æ“ç®—æ˜¯å®ç°äº†ï¼Œå½“ç„¶è¿˜æœ‰å¾ˆå¤šåœ°æ–¹å¯ä»¥å®Œå–„çš„ï¼Œæ¯”å¦‚å¯ä»¥å¢åŠ  <code>:class</code>, <code>:style</code>, <code>:if</code> æˆ– <code>:src</code> ç­‰ç­‰ä½ å¯ä»¥æƒ³åˆ°çš„æŒ‡ä»¤åŠŸèƒ½ï¼Œæ·»åŠ è¿™äº›åŠŸèƒ½éƒ½æ˜¯éå¸¸çš„ç®€å•çš„ã€‚</p>
<p>å…¨ç¯‡ä»‹ç»ä¸‹æ¥ï¼Œæ•´ä¸ªæ ¸å¿ƒæ— éå°±æ˜¯éå†æ•´ä¸ªæ¨¡æ¿çš„èŠ‚ç‚¹æ ‘ï¼Œå…¶æ¬¡é’ˆå¯¹æ¯ä¸€ä¸ªèŠ‚ç‚¹çš„å­—ç¬¦ä¸²å€¼æ¥è§£ææˆå¯¹åº”çš„è¡¨è¾¾å¼ï¼Œç„¶åé€šè¿‡ <code>new Function()</code> è¿™ä¸ªæ„é€ å‡½æ•°æ¥è®¡ç®—æˆå®é™…çš„å€¼ï¼Œæœ€ç»ˆé€šè¿‡æŒ‡ä»¤çš„ <code>update</code> å‡½æ•°æ¥æ›´æ–°åˆ°è§†å›¾ä¸Šã€‚</p>
<p>å¦‚æœè¿˜æ˜¯ä¸æ¸…æ¥šè¿™äº›æŒ‡ä»¤å¦‚ä½•ç¼–å†™çš„è¯ï¼Œå¯ä»¥å‚è€ƒæˆ‘è¿™ä¸ªé¡¹ç›® <a href="https://github.com/colonjs/colon" target="_blank" rel="noopener">colon</a> çš„ç›¸å…³æºç ï¼ˆéƒ¨åˆ†ä»£ç å¯èƒ½ä¼šæœ‰ä¸å½±å“ç†è§£çš„ç»†å¾®å·®åˆ«ï¼Œå¯å¿½ç•¥ï¼‰ï¼Œæœ‰ä»»ä½•é—®é¢˜éƒ½å¯ä»¥åœ¨ issue ä¸Šæã€‚</p>
<p>ç›®å‰æœ‰ä¸€ä¸ªå±€é™å°±æ˜¯ DOM-based çš„æ¨¡æ¿å¼•æ“åªé€‚ç”¨äºæµè§ˆå™¨ç«¯ï¼Œç›®å‰ç¬”è€…ä¹Ÿæ­£åœ¨å®ç°å…¼å®¹ Node ç«¯çš„ç‰ˆæœ¬ï¼Œæ€è·¯æ˜¯æŠŠå­—ç¬¦ä¸²æ¨¡æ¿è§£ææˆ ASTï¼Œç„¶åæŠŠæ›´æ–°æ•°æ®åˆ° AST ä¸Šï¼Œæœ€åå†æŠŠ AST è½¬æˆå­—ç¬¦ä¸²æ¨¡æ¿ï¼Œå®ç°å‡ºæ¥åæœ‰ç©ºçš„è¯å†æ¥ä»‹ç»ä¸€ä¸‹ Node ç«¯çš„å®ç°ã€‚</p>
<p>æœ€åï¼Œå¦‚æœä¸Šé¢æœ‰è¯´å¾—ä¸å¯¹æˆ–è€…æœ‰æ›´å¥½çš„å®ç°æ–¹å¼çš„è¯ï¼Œæ¬¢è¿æŒ‡å‡ºè®¨è®ºã€‚</p>

            </section>
            <footer class="article-meta">
                
                    <div class="follow">
                        <img src="/images/follow.png" alt="å‰ç«¯å°ä¸“æ ">
                        <p class="description">æ›´å¤šå¹²è´§è¯·å…³æ³¨å…¬ä¼—å· <span>å‰ç«¯å°ä¸“æ </span></p>
                    </div>
                
            </footer>
        </article>
    </div>
</div>

<footer class="Footer text-center">
    <div class="container">
        <section class="copyright">
            <a href="https://justclear.github.io">å¤§æ¿æ —</a>
            <span>&copy; 2015 - 2019</span>
        </section>
    </div>
</footer>

    <script src="/dist/js/highlight.pack.js"></script>
    <script src="/dist/js/app.js"></script>
    <!-- <script type="text/javascript" src="https://s4.cnzz.com/z_stat.php?id=1278149431&web_id=1278149431"></script> -->
</body>
</html>

